import { Button, Col, Divider, Form, Icon, Input, Modal, message, Tag } from 'antd';
import React, { Component, RefObject } from 'react';

import { Dispatch } from 'redux';
import { connect } from 'dva';

import { WrappedFormUtils } from 'antd/es/form/Form';
import { FormattedMessage, formatMessage } from 'umi-plugin-react/locale';

import { TablePage } from '@/components/Page';
import { StandardTableColumnProps } from '@/components/StandardTable';
import InlinePopconfirmBtn from '@/components/InlinePopconfirmBtn';
import { ModalForm } from '@/components/Form';


import { $!{entity}StateType, $!{entity}ListItem } from './model.ts';

import { openWindow } from '@/utils/utils';

interface $!{entity}Props {
  dispatch: Dispatch<any>;
  loading: boolean;
  site: $!{entity}StateType;
}

interface $!{entity}State {
  selectedRows: $!{entity}ListItem[];
  showLoginScriptModal: boolean;
  currentRecord?: $!{entity}ListItem;
}

class $!{entity} extends Component<$!{entity}Props, $!{entity}State> {
  state: $!{entity}State = {
    selectedRows: [],
    showLoginScriptModal: false,
  };

  private pageRef: RefObject<TablePage<$!{entity}ListItem>> = React.createRef();
/**
 *
 *
 * @type {StandardTableColumnProps<$!{entity}ListItem>[]}
 * @memberof $!{entity}
 */
columns: StandardTableColumnProps<$!{entity}ListItem>[] = [
        //TODO 生成所有列，国际化设置
    {
      title: <FormattedMessage id="app.martin.site.label.name" />,
      dataIndex: 'name',
      width: 100,
    },
    // 定义最后一列操作按钮
    {
      title: <FormattedMessage id="app.common.label.operation" />,
      align: 'center',
      key: 'operation',
      width: 120,
      fixed: 'right',
      render: (text: string, record: $!{entity}ListItem) => (
        <>
          <ModalForm
            title={formatMessage({ id: 'app.martin.site.edit-the-site' })}
            onSubmit={this.handleEdit}
            element={
              <a>
                <Icon type="edit" />
                <FormattedMessage id="component.common.text.edit" />
              </a>
            }
            formItems={this.modalFormItems}
            formValues={record}
          />
          <Divider type="vertical" />
          <InlinePopconfirmBtn onConfirm={() => this.onDelete([record.id])} />
        </>
      ),
    },
  ];

  modalFormItems = () => [
    //TODO 新增修改时要操作的列
    {
      label: 'id',
      name: 'id',
      itemRender: <Input type="hidden" />,
      hidden: true,
    },
    {
      label: <FormattedMessage id="app.martin.site.label.home-page" />,
      name: 'homePage',
      rules: [
        {
          required: true,
          message: '首页链接不能为空',
        },
        {
          type: 'url',
          message: '请输入正确的链接地址!',
        },
      ],
      itemRender: <Input placeholder="首页链接" />,
    },
    {
      label: <FormattedMessage id="app.martin.site.label.name" />,
      name: 'name',
      rules: [
        {
          required: true,
          message: '站点名称不能为空',
        },
      ],
      itemRender: <Input placeholder="请输入站点全称" />,
    },
  ];

  showModal = (currentRecord: $!{entity}ListItem) => {
    this.setState({ showLoginScriptModal: true, currentRecord });
  };

  /**
   * 删除回调函数
   * @param ids
   */
  onDelete = (ids: string[]) => {
    const { dispatch } = this.props;
    const { selectedRows } = this.state;

    if (!ids) return;
    const that = this;
    dispatch({
      type: 'site/remove',
      payload: {
        ids: ids.join(','),
      },
    })
      // @ts-ignore
      .then(() => {
        that.setState({
          selectedRows: selectedRows.filter(item => ids.indexOf(item.id) === -1),
        });
        if (that.pageRef.current) {
          that.pageRef.current.doSearch();
        }
        message.success(formatMessage({ id: 'component.common.text.deleted-success' }));
      })
      .catch(() => {});
  };

  handleAdd = (fields: any) => this.handleAddOrEdit('site/create', fields);

  handleEdit = (fields: any) => this.handleAddOrEdit('site/modify', fields);

  handleAddOrEdit = (type: string, fields: any) => {
    const { dispatch } = this.props;
    const that = this;
    return dispatch({
      type,
      payload: fields,
      // @ts-ignore
    }).then(() => {
      if (that.pageRef.current) {
        that.pageRef.current.doSearch();
      }
      message.success(
        formatMessage({
          id: `component.common.text.${(type.indexOf('create') !== -1 && 'add') || 'edit'}-success`,
        }),
      );
    });
  };

  handleSelectRows = (rows: $!{entity}ListItem[]) => {
    this.setState({
      selectedRows: rows,
    });
  };

  //配置搜索项
  searchFormRender = (form: WrappedFormUtils) => {
    //TODO 用于搜索的列
    const { getFieldDecorator } = form;
    return (
      [
        <Col md={8} sm={24}>
          <Form.Item label={<FormattedMessage id="app.martin.site.filter.name" />}>
            {getFieldDecorator('name')(<Input placeholder="请输入" />)}
          </Form.Item>
        </Col>,

      ]
    );
  };

  //配置操作项
  operatorRender = () => (
    [
      <ModalForm
        title={formatMessage({ id: 'app.martin.site.add-new-site' })}
        onSubmit={this.handleAdd}
        element={
          <Button type="primary" icon="plus">
            <FormattedMessage id="component.common.text.add" />
          </Button>
        }
        formItems={this.modalFormItems}
      />,

    ]

  );

  render() {
    const {
      dispatch,
      loading,
      site: { data },
    } = this.props;
    const { selectedRows, showLoginScriptModal, currentRecord } = this.state;

    return (
      <>
        <TablePage<$!{entity}ListItem>
          ref={this.pageRef}
          title={formatMessage({ id: 'menu.site' })}
          action="site/fetch"
          columns={this.columns}
          data={data}
          loading={loading}
          searchFormRender={this.searchFormRender}
          operatorRender={this.operatorRender}
          selectedRows={selectedRows}
          handleSelectRows={this.handleSelectRows}
          onDelete={(rows: $!{entity}ListItem[]) => this.onDelete(rows.map(row => row.id))}
          dispatch={dispatch}
        />
      </>
    );
  }
}

export default connect(
  ({
    site,
    loading,
  }: {
    site: $!{entity}StateType;
    loading: {
      models: {
        [key: string]: boolean;
      };
    };
  }) => ({
    site,
    loading: loading.models.site,
  }),
)($!{entity});
